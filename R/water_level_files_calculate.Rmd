---
title: "Water Level Calculations"
author: "Kim Cressman"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(readr)
library(readxl)
library(tidyr)
library(dplyr)
library(janitor)
library(here)
library(lubridate)
library(ggplot2)
```

From the spreadsheet on google drive where people entered information about their "local" sea level rise rates, I have:  

+  saved it to the same directory as the general data transformations on my computer  
+  added a column ("set start") with the year of first SET readings  
+  used the given NWLON station IDs to download mean monthly sea level readings from COOPS (saved in the same directory)  

Here, I loop through all of the saved files and generate output for each reserve/NWLON station:  

+  long-term SLR rate and confidence interval, as a check on methodology. These should match the rates reported by COOPS.  
+  short-term water level change: starting with the year that SETs were first read at the given reserve.  

The statistical method used is an ARIMA, order (1,0,0), regressed on date. This method accounts for the fact that we're looking a time-series and autocorrelation exists in the data. Confidence intervals were retrieved using base R's `confint()` function.  

There is a summary table of rates at the end. Graphs are generated in the loop through stations and the table has to come after everything has been read. Scroll to that if you only want numbers.  

There are two graphs for each reserve. The gray line represents monthly sea level data. The red line is a linear regression on monthly sea level, generated automatically by `ggplot2::geom_smooth()`. The slope may not *exactly* match ARIMA output but should be extremely close (the bigger difference between methods is in the confidence intervals). The blue line is a LOESS smooth, also generated by `ggplot2::geom_smooth()`, with a span set to 0.5. The second graph is the same as the first, with the addition of an orange line representing linear short-term change over the time of SET readings.  

\pagebreak  

```{r}
in_path <- here::here("water_level", "input", "Sea Level Rise Rates.xlsx")
slr_metadat <- read_excel(in_path)
mdat <- slr_metadat %>% 
    clean_names() 
# get rid of any that don't have an NWLON station number
mdat <- mdat[!is.na(mdat$nwlon_station_number), ]    
```

```{r, fig.width = 7.5, fig.height = 4.9, results = "asis"}
# set up outputs

# figure out what's going to be read in and worked on
# list the csv files in the "intermediate" folder
file_names <- grep(".csv", dir(here::here("water_level", "intermediate")), value = TRUE)

out_length <- length(file_names)

# set up data frame for output
rates <- data.frame(reserve = rep(NA_character_, out_length),
                    rate_longterm = rep(0, out_length),
                    CI_low_longterm = rep(0, out_length),
                    CI_high_longterm = rep(0, out_length),
                    rate_19yr = rep(0, out_length),
                    CI_low_19yr = rep(0, out_length),
                    CI_high_19yr = rep(0, out_length),
                    rate_shortterm = rep(0, out_length),
                    CI_low_shortterm = rep(0, out_length),
                    CI_high_shortterm = rep(0, out_length),
                    dates_longterm = rep(NA_character_, out_length),
                    dates_19yr = rep(NA_character_, out_length),
                    dates_shortterm = rep(NA_character_, out_length),
                    stringsAsFactors = FALSE)
```



```{r, fig.width = 7.5, fig.height = 4.9, results = "asis"}

# do it
for(i in 1:length(file_names)){
        
        coops_path <- here::here("water_level", "intermediate", file_names[i])
        coops_dat_raw <- read_csv(coops_path)
        
        # identifying information
        to_match <- substr(file_names[i], 1, 3)
        
        
        # subset the metadata
        mdat_i <- mdat[mdat$reserve == to_match, ]
        
        # NWLON station id
        nwlon <- mdat_i$nwlon_station_number
        
        # long-term dates
        date_min <- mdat_i$data_start
        date_max <- mdat_i$data_end
        
        # short-term start date (use same end date)
        st_min <- mdat_i$set_start
        
        # 19-yr start date (use same end date)
        yr19_min <- date_max - 19
        
        
        # long-term change
        dat <- coops_dat_raw %>%
                clean_names() %>%
                filter(year >= date_min,
                       year <= date_max) %>%
                select(year, month, monthly_msl) %>%
                mutate(date = ymd(paste0(year, month, "-01")),
                       monthly_msl_mm = monthly_msl * 1000)
        
        ari_out <- arima(dat$monthly_msl_mm, order = c(1, 0, 0), xreg = dat$date)
        
        
        # 19-year change
        dat_sub19 <- dat %>% 
            filter(year >= yr19_min)
        ari_out19 <- arima(dat_sub19$monthly_msl_mm, order = c(1, 0, 0), xreg = dat_sub19$date)
        
        
        # short-term change
        dat_sub <- dat %>% 
                filter(year >= st_min)
        ari_out2 <- arima(dat_sub$monthly_msl_mm, order = c(1, 0, 0), xreg = dat_sub$date)
        
        
        # insert all the rates
        rates[i, ] <- c(to_match, 
                        ari_out$coef[3] * 365.25,
                        confint(ari_out)[3, 1] * 365.25,
                        confint(ari_out)[3, 2] * 365.25,
                        ari_out19$coef[3] * 365.25,
                        confint(ari_out19)[3, 1] * 365.25,
                        confint(ari_out19)[3, 2] * 365.25,
                        ari_out2$coef[3] * 365.25,
                        confint(ari_out2)[3, 1] * 365.25,
                        confint(ari_out2)[3, 2] * 365.25,
                        paste0(date_min, "-", date_max),
                        paste0(yr19_min, "-", date_max),
                        paste0(st_min, "-", date_max))
        
        p <- ggplot(dat, aes(x = date, y = monthly_msl)) +
            geom_line(size = 0.7, col = "gray70") +
            geom_smooth(method = "lm", col = "red3", 
                        size = 1.5, se = FALSE,
                        alpha = 0.6) +
            geom_smooth(method = "loess", se = FALSE,
                        span = 0.5, size = 1.5,
                        alpha = 0.6) +
            labs(title = paste0("Monthly Mean Sea Level for ", 
                                to_match, "; NWLON station ", nwlon),
                 subtitle = paste0("Red = lm smooth; Blue = loess smooth, span 0.5 \nlong-term change: ", round(ari_out$coef[3] * 365.25, 2), " mm/yr"),
                 x = "Date",
                 y = "mean sea level (m)") +
            theme_classic()

        
        q <- p +
                geom_smooth(data = dat_sub19, aes(x = date, y = monthly_msl), 
                            col = "green3", method = "lm", 
                            size = 2.5, se = FALSE,
                            alpha = 0.5) +
                labs(title = paste0("Monthly Mean Sea Level for ", 
                                    to_match, "; NWLON station ", nwlon),
                     subtitle = paste0("Red = lm smooth; Blue = loess smooth, span 0.5; Green = lm for ", yr19_min, "-", date_max, "\nlong-term change: ", round(ari_out$coef[3] * 365.25, 2), "; 19-yr change: ", round(ari_out19$coef[3] * 365.25, 2)),
                     x = "Date",
                     y = "mean sea level (m)")
        
        
        r <- p +
                geom_smooth(data = dat_sub, aes(x = date, y = monthly_msl), 
                            col = "orange", method = "lm", 
                            size = 3, se = FALSE,
                            alpha = 0.5) +
                labs(title = paste0("Monthly Mean Sea Level for ", 
                                    to_match, "; NWLON station ", nwlon),
                     subtitle = paste0("Red = lm smooth; Blue = loess smooth, span 0.5; Orange = lm for ", st_min, "-", date_max, "\nlong-term change: ", round(ari_out$coef[3] * 365.25, 2), "; short-term change: ", round(ari_out2$coef[3] * 365.25, 2)),
                     x = "Date",
                     y = "mean sea level (m)")
        
        # print the plots into the document
        print(p)
        cat("  \n***   \n***  \n")
        cat("  \n***   \n***  \n")
        cat("  \n***   \n***  \n")
        cat("  \n***   \n***  \n")
        print(q)
        cat("  \n***   \n***  \n")
        print(r)
        
        
        # save the plots for later use
        # generate names
        plot_out_path <- here::here("water_level", "output")
        plot_out_name_p <- paste0(plot_out_path, "/", to_match, "_SLRplot.svg")
        plot_out_name_q <- paste0(plot_out_path, "/", to_match, "_SLRplus19plot.svg")
        plot_out_name_r <- paste0(plot_out_path, "/", to_match, "_SLRplusSTplot.svg")
        # save
        ggsave(filename = plot_out_name_p, plot = p, width = 7.5, height = 4.9, units = "in")
        ggsave(filename = plot_out_name_q, plot = q, width = 7.5, height = 4.9, units = "in")
        ggsave(filename = plot_out_name_r, plot = r, width = 7.5, height = 4.9, units = "in")
}

```

\pagebreak  

**Rates**  

LT = long-term; yr19 = 19-year; ST = short-term  

All rates in mm/yr  

```{r}
ratesb <- rates %>% 
    mutate_at(2:10, as.numeric) %>% 
    mutate(LT_CI = paste(round(CI_low_longterm, 2), 
                         round(CI_high_longterm, 2), sep = "-"),
           Mid_CI = paste(round(CI_low_19yr, 2), 
                         round(CI_high_19yr, 2), sep = "-"),
           ST_CI = paste(round(CI_low_shortterm, 2), 
                         round(CI_high_shortterm, 2), sep = "-")) %>% 
    select(reserve, rate_longterm, LT_CI, rate_19yr, Mid_CI, rate_shortterm, ST_CI, dates_longterm, dates_19yr, dates_shortterm)

knitr::kable(ratesb, digits = 3, align = "c",
             col.names = c("Reserve",
                           "LT change",
                           "LT CI",
                           "19-yr change",
                           "19-yr CI",
                           "ST change",
                           "ST CI",
                           "LT dates",
                           "19-yr dates",
                           "ST dates"))

# write a file to be used in other scripts
out_path <- here::here("water_level", "output")
out_name <- paste0(out_path, "/00SLRrates_all.csv")
write.csv(rates, out_name, row.names = FALSE)
```

```{r}
# graph the rates
rates2 <- rates 

names(rates2) <- c("Reserve", 
                   "LT change", "LT CI_low", "LT CI_high",
                   "Mid_19yr change", "Mid_19yr CI_low", "Mid_19yr CI_high",
                   "ST change", "ST CI_low", "ST CI_high", 
                   "LT dates", "Mid_19yr dates", "ST dates")

rates2 %>% 
    gather(key = "param", value = "value", -Reserve) %>% 
    separate(param, into = c("long_mid_short", "param"), sep = " ") %>% 
    spread(key = param, value = value) %>% 
    mutate_at(3:5, as.numeric) %>% 
    group_by(Reserve, long_mid_short) %>% 
    ggplot(aes(group = long_mid_short, color = long_mid_short)) +
    geom_hline(aes(yintercept = 0), col = "black", size = 1) +
    geom_point(aes(x = Reserve, y = change), position = position_dodge(width = 0.8)) +
    geom_errorbar(aes(x = Reserve, ymin = CI_low, ymax = CI_high), position = position_dodge(width = 0.8)) +
    scale_color_brewer(palette = "Set1") +
    labs(title = "Water Level Change by Reserve",
         x = "Reserve",
         y = "Rate of Change, mm/yr",
         color = "Long-, Mid-, or Short-term") +
    theme_minimal() +
    theme(legend.position = "bottom")

# save the graph (svg and pdf)
out_name <- paste0(out_path, "/00SLRrates_all.svg")
ggsave(filename = out_name, width = 8, height = 6, units = "in")

out_name <- paste0(out_path, "/00SLRrates_all.pdf")
ggsave(filename = out_name, width = 8, height = 6, units = "in")
```

```{r}
# merge the tables and write it out
rates3 <- full_join(rates2, mdat, by = c("Reserve" = "reserve"))
out_path <- here::here("water_level", "output")
out_name <- paste0(out_path, "/00SLRrates_and_COOPsinfo.csv")
write.csv(rates3, out_name, row.names = FALSE)
```

